<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Jadwal Rapat PT PEMA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; }
        .table thead { background: #0d6efd; color: #fff; }
        .table tbody tr { transition: background 0.2s; }
        .table tbody tr:hover { background: #e7f1ff; }
        .badge-zoom { background: #198754; }
        .badge-konsumsi { background: #ffc107; color: #333; }
        .agenda { font-size: 1.1em; font-weight: 500; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h2 class="mb-4 text-center">Jadwal Rapat PT PEMA</h2>
        <div class="row" id="jadwal-ruang"></div>
        <div class="text-center mt-4 text-muted" id="lastUpdate"></div>
    </div>
    <script>
        // Helper untuk format tanggal Indonesia
        function formatTanggalIndo(date) {
            const bulan = [
                "Januari", "Februari", "Maret", "April", "Mei", "Juni",
                "Juli", "Agustus", "September", "Oktober", "November", "Desember"
            ];
            const hari = [
                "Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"
            ];
            return hari[date.getDay()] + ', ' + date.getDate() + ' ' + bulan[date.getMonth()] + ' ' + date.getFullYear();
        }

        // List ruang rapat
        const ruangList = [
            'Ruang Growth', 'Ruang Harmony', 'Ruang Kopiah', 'Ruang Internasional'
        ];

        let lastHash = '';
        async function loadJadwal(force = false) {
            const res = await fetch('/api/jadwal-rapat');
            if (!res.ok) {
                document.getElementById('jadwal-ruang').innerHTML = '<div class="text-danger text-center">Gagal memuat data.</div>';
                return;
            }
            const data = await res.json();
            // Buat hash sederhana dari data untuk deteksi perubahan
            const hash = JSON.stringify(data);
            if (!force && hash === lastHash) return;
            lastHash = hash;

            // Filter hanya hari ini
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            const dataToday = (data || []).filter(r => r.tanggal === todayStr);

            // Kelompokkan per ruang
            const ruangMap = {};
            ruangList.forEach(r => ruangMap[r] = []);
            dataToday.forEach(r => {
                if (ruangMap[r.ruang]) ruangMap[r.ruang].push(r);
            });

            // Render per ruang
            const jadwalDiv = document.getElementById('jadwal-ruang');
            jadwalDiv.innerHTML = '';
            ruangList.forEach(ruang => {
                const events = ruangMap[ruang] || [];
                let html = `<div class="col-md-3 mb-4"><div class="card shadow-sm h-100">
                    <div class="card-header text-center fw-bold bg-primary text-white">${ruang}</div>
                    <div class="card-body p-2">`;
                if (!events.length) {
                    html += `<div class="text-center text-muted">Tidak ada rapat</div>`;
                } else {
                    // Sort by jam mulai
                    events.sort((a, b) => (a.jam || '').localeCompare(b.jam || ''));
                    events.forEach(ev => {
                        // Cek apakah rapat sedang berlangsung
                        let isOngoing = false;
                        if (ev.jam && ev.jam_selesai) {
                            const jamMulai = ev.jam;
                            const jamSelesai = ev.jam_selesai;
                            const nowTime = now.toTimeString().slice(0,5);
                            isOngoing = (jamMulai <= nowTime && nowTime < jamSelesai);
                        }
                        html += `<div class="mb-2 p-2 rounded ${isOngoing ? 'bg-success text-white' : 'bg-light'}" style="border-left:4px solid ${isOngoing ? '#198754' : '#0d6efd'};">
                            <div class="fw-bold">${ev.jam || '-'}${ev.jam_selesai ? ' - ' + ev.jam_selesai : ''}</div>
                            <div class="agenda">${ev.agenda || '-'}</div>
                            <div style="font-size:13px;opacity:0.8;">PIC: ${ev.pic_name || '-'}</div>
                            ${ev.butuh_konsumsi ? `<span class="badge bg-warning text-dark">Konsumsi</span>` : ''}
                            ${ev.butuh_zoom && ev.zoom_link ? `<a href="${ev.zoom_link}" target="_blank" class="badge bg-success ms-1">Zoom</a>` : ''}
                        </div>`;
                    });
                }
                html += `</div></div></div>`;
                jadwalDiv.innerHTML += html;
            });

            document.getElementById('lastUpdate').textContent =
                'Hari ini: ' + formatTanggalIndo(new Date()) + ' | Terakhir update: ' + new Date().toLocaleTimeString('id-ID');
        }
        // Panggil setiap detik
        setInterval(() => loadJadwal(), 1000);
        // Panggil sekali saat awal
        loadJadwal(true);
    </script>
</body>
</html>
